---
title: "Server Side Dart を始めて一年が経った話"
emoji: "🎯"
type: "tech"
publication_name: "zoome"
topics: [Dart]
published: false
---

去年の三月から試験的に Server Side Dart を導入し、一年と少しが経ちました。

現時点で[敬語翻訳](https://honorific.app)、[AITuberプロジェクト](https://aituber.net)、[Batty](https://batty.life)において、アプリ側もサーバー側もDartで書いています。

# Server Side Dart を採用した理由
弊社は小規模なサービスを自社開発している、個人開発の延長線上にあるような会社です。
開発手順にはMVP (Minimum Viable Product)を用いることが多く、なるべく早めにアプリを公開し、利用者からの反応を窺うようにしています。
その際に可能な限り早く実装でき、不具合も起こさない方法として**アプリとサーバー側の開発言語の統一**を考えました。

ちなみにBaaSの利用も検討しましたが、利用者が増えた時に備えて移行を簡単にしたい、通信にUDPを使っている・使う可能性のあるサービスがある等の事情からIaaSにしています。

# 実際どうなの
結論としては「**短期的な開発速度が上がりミスも減るものの、将来的に別言語への移行が必要**」です。
理由としては後述する「ライブラリー不足」と「スレッド間のメモリー共有が出来ない」という点で、サーバー側が大規模になると厳しいものがあります。

# 良い点
## 実装が早い
最初はライブラリーもフレームワークも無いので
gRPC+Dart

## ミスが減る
一人でアプリ側とサーバー側の両方を実装する場合、それぞれの言語が違うとコード記法や型の違いに苦労しますし、細かい仕様の違いによって結構ミスを起こしがちです。
コンパイルが通らないくらいあからさまなミスであれば問題ありませんが、言語ごとの値の範囲などの違いや、無駄に速度が遅くなってしまうなどのミスは十分なテストをしていない限り中々気付けません。

## 生成物がバイナリーファイル一つ
他に同様のことが出来る言語も多いのですが、バイナリーファイルを一個置くだけというのはセキュリティーの管理が楽で良いです。

# 悪い点
## ライブラリー不足
実装の際に起きたトラブルの9割程はこれに起因します。
特に Google Cloud 用の公式ライブラリー([googleapis](https://pub.dev/packages/googleapis))の対応状況が他よりも少ないことに困りました。
例えば[Error Reporting](https://cloud.google.com/error-reporting?hl=ja) のスタックトレースの収集も

> 例外スタック トレースのパーサーは、Go、Java™、.NET、Node.js、PHP、Python、Ruby を解析できます。

Dartが無い…。※DartはGoogle社が開発した言語です
他にも自己署名URLでアプリから直接ファイルをアップロードしてもらえる仕組みにしようと思ったら、自己署名URLの作成機能がDartだけありませんでした（他の言語には全部ありました）

## フレームワーク不足
[serverpod](https://pub.dev/packages/serverpod)がありますが、REST限定なのと、ソースコードを読んだ限りでは`Isolate`を使用していないので、シングルスレッドでしか動作しなさそうです。
とはいえgRPCを使用すれば大部分を自動生成してくれるので、DBの更新と取得、定期的なバッチ処理くらいしか必要ないのですが。

# 実装に伴う注意点
## Isolateでマルチスレッドに対応する
DartはNode.jsやTypeScriptと同じく、シングルスレッドで効率良く非同期処理が行える代わりに、スレッド間でのメモリー共有が出来ない仕組みになっています。

CPUとメモリー効率を最大化させるためには`Isolate`を使用してマルチスレッドで処理させる必要があります。
また、スレッド間で変数を受け渡すには`ReceivePort`と`SendPort`を使って送受信します。

## エンドポイント（gRPCのサービス）ごとにポートを分ける
弊社ではサービスごとにポートを分けたものをEnvoyで443ポートにリバースプロキシで集約し、Cloudflare DNS Proxy を介して通信をしています。

全てのサービスを一つのポートに集約させて、それを443ポートでリバースプロキシすると他言語に移行する時に苦労します。

# まとめ：夢はあるけど足りないものが多い
DartはNode.jsと同じくC10K問題を解決できるので、多重接続が起こりうるエンドポイントにおいて、アプリ側がFlutterであれば採用に値するだけの恩恵が得られる状況は多いと思います。
アプリとサーバーで一部のコードやテストの共有が出来ることでコード量の削減が行えますし、それに伴って不具合の起きる可能性も減らせます。

弊社のように、基本的にアプリ側もサーバー側も一人でコードを書くという状況でない限り、サーバー側の大部分を Server Side Dart にする利点は薄いと思います。
