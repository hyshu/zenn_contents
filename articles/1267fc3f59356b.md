---
title: "Server Side Dart を始めて一年が経った話"
emoji: "🎯"
type: "tech"
publication_name: "zoome"
topics: [Dart]
published: false
---

去年の三月から試験的に Server Side Dart を導入し、一年と少しが経ちました。

現時点で[敬語翻訳](https://honorific.app)、[AITuberプロジェクト](https://aituber.net)、[Batty](https://batty.life)において、アプリ側もサーバー側もDartで書いています。

# 何故使うのか
弊社は小規模なサービスを自社開発している、個人開発の延長線上にあるような会社です。
開発手順にはMVP (Minimum Viable Product)を用いることが多く、なるべく早めにアプリを公開し、利用者からの反応を窺うようにしています。
その際に可能な限り早く実装でき、不具合も起こさない方法として**アプリとサーバー側の開発言語の統一**を試したかったためです。

# 実際どうなの
結論としては「**短期的な開発速度が上がりミスも減るものの、将来的に別言語への移行が必要**」です。
理由としては後述する「ライブラリー不足」と「スレッド間のメモリー共有が出来ない」という点で、サーバー側が大規模になると厳しいものがあります。

# 良い点
## 実装が早い
最初はライブラリーもフレームワークも少ないので苦労しますが、一通り準備が整うと早いです。
一人で作る時はアプリとサーバー間のコードを行ったり来たりしますが、頭の中で言語を切り替えなくて良い感覚は病みつきになりますね。

gRPCを使用すれば大部分を自動生成してくれるので、各エンドポイントごとの処理やDBの更新と取得、定期的なバッチ処理くらいしか必要なく、想像以上に実装しやすかったです。

## ミスが減る
アプリ側とサーバー側の両方を一人で実装する場合、それぞれの言語が違うとコード記法や型の違いに苦労しますし、細かい仕様の違いによって結構ミスを起こしがちです。
コンパイルが通らないくらいあからさまなミスであれば問題ありませんが、言語ごとの値の範囲などの違いや、動作は問題ないものの無駄に速度が遅くなってしまうようなミスは、十分なテストをしていない限り中々気付けません。

## 生成物がバイナリーファイル一つ
他に同様のことが出来る言語も多いのですが、バイナリーファイルを一個置くだけというのはセキュリティーの管理が楽で良いです。

# 悪い点
## ライブラリー不足
実装の際に起きたトラブルの9割程はこれに起因します。

例えば[Error Reporting](https://cloud.google.com/error-reporting?hl=ja) のスタックトレースの収集も、

> 例外スタック トレースのパーサーは、Go、Java™、.NET、Node.js、PHP、Python、Ruby を解析できます。

Dartが無い…。※DartはGoogle社が開発している言語です

他にも自己署名URLでアプリから直接ファイルを Cloud Storage にアップロードしてもらう仕組みにしようと思ったら、Google Cloud の公式ライブラリー([googleapis](https://pub.dev/packages/googleapis))に自己署名URLの作成機能がDartだけありませんでした。

という感じで、Dartには[pub.dev](https://pub.dev)という素晴らしい公開プラットフォームはあるものの、サービス単位で見ると対応していないことが多かったです。

## マルチスレッド化が難しい
Server Side TypeScript と同じ問題ですが、DartもJavascript派生の言語なのでマルチスレッドにするとスレッド間でメモリーが共有されません。
なので上手い具合に役割を分担させ、必要なデータはDBを介して取得するか、SQLのレプリケーションのようにスレッド間で同期をする処理を考える必要があります。

# 実装に伴う注意点
## エンドポイント（gRPCのサービス）ごとにポートを分ける
弊社ではエンドポイントごとにポートを分けたものをEnvoyで443ポートにリバースプロキシで集約し、Cloudflare DNS Proxy を介して通信をしています。

全てのエンドポイントを一つのポートに集約させて、それを443ポートでリバースプロキシすると他言語に移行する時に苦労します。

# まとめ：夢はあるけど足りないものが多い
DartはNode.jsやTypeScriptと同じくC10K問題を解決できるので、多重接続が起こり得るエンドポイントにおいて、アプリ側もDart（Flutter）であれば採用に値するだけの恩恵が得られる状況はあると思います。
アプリとサーバーで一部のコードやテストの共有が行えるため、コード量の削減が行えますし、それに伴って不具合の起きる可能性も減らせます。

弊社のように、基本的にアプリ側もサーバー側も一人でコードを書くという状況でない限り、サーバー側の大部分を Server Side Dart にする利点は薄いと思います。

# 余談：今後はどうする？
私はアプリエンジニアなので、サーバー側を凝った構成にする技術はありません。
アクセス増に備えてk8sでオーケストレーションだ！なんてことをしたら事故ること間違いなし。
大したコード量にはなりませんし、現状のまま Server Side Dart で運用していく予定です。

アップスケールで対応できない状況になるのってMAU何百万人という規模でしょうし、そこまでになれば採算も取れるでしょうから、優秀なサーバーサイドエンジニアの人にGo言語などで作り直してもらう形になるのかなと思います。
