---
title: "ã€KMPå…¥é–€ã€‘ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ã‚‹"
emoji: "ğŸ”¢"
type: "tech"
topics: [kmp, swiftui, jetpackcompose, fleet]
publication_name: "zoome"
published: true
---

ä»Šå›ã¯ Kotlin Multiplatform (KMP) ã§ç°¡å˜ãªã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

KMPã®å…±é€šã‚³ãƒ¼ãƒ‰ã§å€¤ã‚’ç®¡ç†ã—ã€å€¤ãŒå¤‰åŒ–ã—ãŸã‚‰ã‚¢ãƒ—ãƒªã®ç”»é¢ã«åæ˜ ã•ã›ã¾ã™ã€‚

# ã¾ãšã¯ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
ã¾ãšã¯[å‰å›ã®è¨˜äº‹](2e4ae44af773be)ã§ä½œæˆã—ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã™ã£ãã‚Šã•ã›ã¾ã™ã€‚
:::details ã“ã®è¨˜äº‹ã‹ã‚‰èª­ã‚“ã æ–¹å‘ã‘ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
KMPã§æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹ã«ã¯ **Kotlin Multiplatform Wizard** ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
https://kmp.jetbrains.com

![Kotlin Multiplatform Wizard ã®é¸æŠç”»é¢](/images/p2ui9dxdad.webp)

ä»Šå›ã¯iOSã®ã€Œ**Do not share UI (use only SwiftUI)**ã€ã‚’é¸æŠã—ã¾ã™ã€‚ä»–ã®è¨­å®šã¯åˆæœŸçŠ¶æ…‹ã®ã¾ã¾ã§æ§‹ã„ã¾ã›ã‚“ã€‚

ã€Œ**Share UI (with Compose Multiplatform UI framework)**ã€ã®æ–¹ã¯CMPã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€ç°¡æ½”ã«è¨€ã†ã¨Kotlinç‰ˆFlutterãªã®ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ã¾ãŸåˆ¥ã®è¨˜äº‹ã§ã”èª¬æ˜ã—ã¾ã™ã€‚

# Fleetã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
æ¬¡ã«ã€KMPé–‹ç™ºå…ƒã®å…¬å¼ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã‚ã‚‹**Fleet**ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
https://www.jetbrains.com/ja-jp/fleet/

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰Fleetã‚’èµ·å‹•ã—ã€ã€ŒOpen...ã€ã‹ã‚‰å…ˆã»ã©ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ãã¾ã™ã€‚

![Fleetã®åˆæœŸèµ·å‹•ç”»é¢](/images/dryniu9jxm.webp)

ä»¥ä¸‹ã®ç”»é¢ã«ãªã£ãŸã‚‰æº–å‚™å®Œäº†ã§ã™ã€‚
![Fleetã§ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã„ãŸæ™‚ã®ç”»é¢](/images/ucnad6c3fg.webp)
:::

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
1. **composeApp/src/commonMain** ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã”ã¨
2. **shared/src/androidMain**ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã”ã¨
3. **shared/src/iosMain**ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã”ã¨
4. **shared/src/commonMain/kotlin/org/example/prject/Greeting.kt**
5. **shared/src/commonMain/kotlin/org/example/prject/Platform.kt**

æ¬¡ã«ã€`App.kt`ã¨`CounterView.swift`ã‚’ã™ã£ãã‚Šã•ã›ã¾ã™ã€‚
```kotlin:App.kt
package org.example.project

import androidx.compose.material.*
import androidx.compose.runtime.*

@Composable
fun App() {
    MaterialTheme {
    }
}
```

```swift:ContentView.swift
import SwiftUI
import Shared

struct ContentView: View {
    var body: some View {
        VStack {
        }
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
```

æœ€å¾Œã«KMPã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ãŒ0å€‹ã ã¨ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã™ã‚‹ã®ã§`Counter.kt`ã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚
**å³ã‚¯ãƒªãƒƒã‚¯â†’New File...** ã§æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã§ãã¾ã™ã€‚

![shared/src/commonMain/kotlin/org/example/project ã§å³ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ§˜å­](/images/9t3hmdsjz3.webp)

![New File...ã‚’é¸æŠå¾Œã€Counter.ktã¨å…¥åŠ›](/images/cdyp5a4jt2.webp)

ã“ã‚Œã§çœŸã£ç™½ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆå®Œäº†ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨çœŸã£ç™½ãªç”»é¢ã ã‘ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

# å…±é€šã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
KMPã¯åˆæœŸçŠ¶æ…‹ã ã¨å…±é€šã‚³ãƒ¼ãƒ‰å´ã‹ã‚‰Androidã€iOSã«å€¤ã®å¤‰åŒ–ã‚’ä¼ãˆã‚‹æ‰‹æ®µãŒãªã„ã®ã§ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ï¼ˆã¨è¨€ã£ã¦ã‚‚Kotlinå…¬å¼ã®ã§ã™ãŒï¼‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`shared/build.gradle.kts`ã®ä¸­ã«`put your Multiplatform dependencies here`ã¨ã„ã†ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã®ã§ã€ãã“ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```gradle diff:build.gradle.kts
sourceSets {
    commonMain.dependencies {
-       // put your Multiplatform dependencies here
+      implementation(libs.kotlinx.coroutines.core)
    }
}
```

:::details ã‚‚ã—Gradleã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å ´åˆ
ä¸€æ—¦ä»¥ä¸‹ã®æ›¸ãæ–¹ã«ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã›ãŸå¾Œã€ä¸Šè¨˜ã®`libs.kotlinx.coroutines.core`ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
```gradle diff:build.gradle.kts
sourceSets {
    commonMain.dependencies {
-       // put your Multiplatform dependencies here
+      implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:latest.release")
    }
}
```
:::

æ¬¡ã«ã€`counter.kt`ã«`Counter`ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```kotlin:counter.kt
package org.example.project

import kotlinx.coroutines.flow.MutableStateFlow

class Counter {
    val count = MutableStateFlow(0)
    fun increment() {
        count.value += 1
    }

    fun decrement() {
        count.value -= 1
    }
}
```

:::message
`MutableStateFlow`ã¯`coroutines`ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚å¤§é›‘æŠŠã«è¨€ã†ã¨ã€Swiftã®[Combine](https://developer.apple.com/documentation/combine)ã®[CurrentValueSubject](https://developer.apple.com/documentation/combine/currentvaluesubject)ã€React Nativeï¼ˆã¨ã„ã†ã‚ˆã‚ŠJavascriptï¼‰ã®[RxJS](https://rxjs.dev)ã®[BehaviorSubject](https://rxjs.dev/api/index/class/BehaviorSubject)ã€Flutterã®[StreamController](https://api.flutter.dev/flutter/dart-async/StreamController-class.html)ã®å€¤ã‚’ä¿æŒã™ã‚‹ç‰ˆï¼ˆè¦ã¯[rxdart](https://pub.dev/packages/rxdart)ã®[BehaviorSubject](https://pub.dev/documentation/rxdart/latest/rx/BehaviorSubject-class.html)ï¼‰ã«ç›¸å½“ã—ã¾ã™ã€‚
:::

:::details ã‚³ãƒ¼ãƒ‰ã®ä¿å­˜æ™‚ã«è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
Fleetã®ç”»é¢å³ä¸Šã®å…­è§’å½¢ãƒœã‚¿ãƒ³ã‹ã‚‰Settingsâ†’Globalâ†’Editorâ†’Codeã«ã‚ã‚‹ã€ŒReformat code on saveã€ã‚’ONã«ã™ã‚‹ã¨ä¿å­˜æ™‚ã«è‡ªå‹•æ•´å½¢ã—ã¦ãã‚Œã¾ã™ã€‚
:::

# Jetpack Compose ã§ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å®Ÿè£…

```kotlin:App.kt
package org.example.project

import androidx.compose.foundation.layout.*
import androidx.compose.material.*
import androidx.compose.runtime.*
import androidx.compose.ui.*
import androidx.compose.ui.unit.dp

@Composable
// KMPã®å…±é€šã‚³ãƒ¼ãƒ‰
fun App(counter: Counter) {
    // KMPã®å…±é€šã‚³ãƒ¼ãƒ‰ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å€¤ã¨ç´ã¥ã‘ã¦ã€å€¤ã®æ›´æ–°ã‚’ç”»é¢ã«åæ˜ ã•ã›ã‚‹
    val count by counter.count.collectAsState()

    MaterialTheme {
        // ç”»é¢ä¸­å¤®ã«ãƒ†ã‚­ã‚¹ãƒˆã‚„ãƒœã‚¿ãƒ³ã‚’ç½®ã‹ã›ã‚‹ãŸã‚ã®Column
        Column(
            modifier = Modifier.fillMaxSize(),
            verticalArrangement = Arrangement.Center,
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text("count: $count")
            // ãƒ‡ã‚¶ã‚¤ãƒ³èª¿ç¯€ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹
            Spacer(modifier = Modifier.height(16.dp))
            // +ãƒœã‚¿ãƒ³ã¨-ãƒœã‚¿ãƒ³
            Row {
                Button(onClick = { counter.increment() }) {
                    Text("+")
                }
                // ãƒ‡ã‚¶ã‚¤ãƒ³èª¿ç¯€ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹ãã®2
                Spacer(modifier = Modifier.width(8.dp))
                Button(onClick = { counter.decrement() }) {
                    Text("-")
                }
            }
        }
    }
}
```

ã“ã®ã‚ˆã†ã«ã€KMPå…±é€šã‚³ãƒ¼ãƒ‰ã‚‚ Jetpack Compose ã‚‚Kotlinãªã®ã§ã€`collectAsState()`ã¨ç´ã¥ã‘ãŸå¤‰æ•°ã‚’ä¸€ã¤æ›¸ãã ã‘ã§ç°¡å˜ã«å€¤ã®å¤‰æ›´ã‚’ç”»é¢ã«åæ˜ ã§ãã¾ã™ã€‚

`App`ã«å¼•æ•°ãŒå¢—ãˆãŸã®ã§`MainActivity.kt`ã«å°‘ã—ã ã‘æ‰‹ã‚’åŠ ãˆã¾ã™ã€‚
```kotlin diff:MainActivity.kt
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        setContent {
-           App()
+           App(Counter())
        }
    }
}

@Preview
@Composable
fun AppAndroidPreview() {
-   App()
+   App(Counter())
}
```

ã“ã‚Œã§Androidç‰ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã®å®Œæˆã§ã™ã€‚

![Jetpack Compose ã¨KMPã§ä½œæˆã—ãŸã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã®ç”»é¢](/images/6i34ejm7s9.webp)

# SwiftUI ã§ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å®Ÿè£…
è¨€èªã®é•ã„ã®ã›ã„ã‹Swiftã«ã¯Kotlinã®ã‚ˆã†ã«`collectAsState()`ãŒç„¡ã„ãŸã‚ã€ä»£ã‚ã‚Šã«`collect`ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã™ãŒã€å¼•æ•°ãŒ`Kotlinx_coroutines_coreFlowCollector`ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã«ãªã£ã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã¾ãšã¯ã“ã‚Œã‚’ç¶™æ‰¿ã—ãŸ`Collector`ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚

```swift:Collector.swift
import Shared

class Collector<T>: Kotlinx_coroutines_coreFlowCollector {
    // å€¤ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ã«å‘¼ã°ã‚Œã‚‹
    let callback: (T) -> Void

    init(callback: @escaping (T) -> Void) {
      self.callback = callback
    }

    func emit(value: Any?, completionHandler: @escaping ((any Error)?) -> Void) {
      callback(value as! T)
      // æœ€å¾Œã«completionHandlerã‚’å‘¼ã°ãªã„ã¨å€¤ã®å¤‰æ›´ãŒæ›´æ–°ã•ã‚Œãªã„ã®ã§ã”æ³¨æ„
      completionHandler(nil)
    }
}
```

æ¬¡ã«ContentView.swiftã‚’æ›´æ–°ã—ã¾ã™ã€‚Jetpack Compose ã¨ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã»ã¼åŒã˜ã§ã™ã€‚

```swift:ContentView.swift
import SwiftUI
import Shared

struct ContentView: View {
    // KMPã®ã‚¯ãƒ©ã‚¹ã‚’å¤‰æ•°ã¨ã—ã¦æŒã£ã¦ãŠã
    private let counter = Counter()
    @State private var count = 0

    var body: some View {
        VStack(spacing: 16) {
            Text("Count: \(count)")
            HStack(spacing: 32) {
                Button(action: {
                    counter.increment()
                }) {
                    Text("+")
                }
                Button(action: {
                    counter.decrement()
                }) {
                    Text("-")
                }
            }
        }
        .padding()
        // ContentViewãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ã«ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹
        .onAppear {
            // KMPå´ã®å€¤ã®å¤‰åŒ–ã‚’@Stateä»˜ãã®å¤‰æ•°countã«åæ˜ ã•ã›ã‚‹
            counter.count.collect(collector: Collector<Int> {
                self.count = $0
            }, completionHandler: { _ in })
        }
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
```

![SwiftUIã¨KMPã§ä½œæˆã—ãŸã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã®ç”»é¢](/images/8p48sk7c2b.webp)

Jetpack Compose ã¨é•ã„ã€SwiftUIã¯ä¸€è¡Œã§æ›¸ã‘ã‚‹ãŠæ‰‹è»½ãªæ›¸ãæ–¹ãŒãªã„ã®ã§å°‘ã—é¢å€’ã§ã™ãŒã€ä»Šå›ä½œã£ãŸ`Collector`ã‚’ä½¿ãˆã°ç°¡å˜ãªã‚¢ãƒ—ãƒªãªã‚‰ååˆ†ã‹ãªã¨æ€ã„ã¾ã™ã€‚

`extension`ã‚’ä½¿ã†ç­‰ã§ã‚‚ã†å°‘ã—çŸ­ãå‡ºæ¥ãã†ãªã®ã§ã€è‰¯ã„æ„Ÿã˜ã®æ›¸ãæ–¹ãŒåˆ†ã‹ã‚Œã°ã¾ãŸè¨˜äº‹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ãŠã‚ã‚Šã«
ä»Šå›ã®ã‚ˆã†ã«å°è¦æ¨¡ãªã‚¢ãƒ—ãƒªã ã¨åˆ©ç‚¹ãŒåˆ†ã‹ã‚Šã¥ã‚‰ã„ã¨æ€ã„ã¾ã™ãŒã€ã‚³ãƒ¼ãƒ‰é‡ãŒå¢—ãˆãŸã‚Šã€é€šä¿¡å‡¦ç†ãŒå¿…è¦ã«ãªã£ãŸã‚Šã™ã‚‹ã¨æ©æµãŒå¤§ãããªã£ã¦ã„ãã¾ã™ã€‚

ã¡ãªã¿ã«ä»Šå›ã¯å…±é€šã‚³ãƒ¼ãƒ‰å†…ã®å€¤ã®æ›´æ–°ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–å´ã«åæ˜ ã•ã›ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã‚Šã¾ã—ãŸãŒã€å®Ÿéš›ã¯ã“ã“ã¾ã§ã™ã‚‹å¿…è¦ã¯ãªãã€è¨ˆç®—å‡¦ç†ï¼ˆBusiness Logicï¼‰ã‚„ã‚¯ãƒ©ã‚¹ç­‰ã®å®šç¾©ï¼ˆDomainï¼‰ã®å…±é€šåŒ–ã ã‘ã§ã‚‚ååˆ†ä¾¿åˆ©ã‹ãªã¨æ€ã„ã¾ã™ã€‚

ä½™è«‡ã§ã™ãŒmixi2ã«KMPã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚’ä½œã‚Šã¾ã—ãŸã€‚
ç§ã‚‚çµ¶è³›å‹‰å¼·ä¸­ãªã®ã§ã€ã—ã°ã‚‰ãã¯è¨˜äº‹ã‚„KMPé–¢ä¿‚ã®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æŠ•ç¨¿ã™ã‚‹ã ã‘ã«ãªã‚Šãã†ã§ã™ãŒã€ã‚‚ã—è‰¯ã‹ã£ãŸã‚‰æ˜¯é(^_^;)
https://mixi.social/communities/8323123c-cd05-46ea-9e5d-4f097763cf22?r=c6fi80fmwy5y

# å‚è€ƒæ–‡çŒ®
[Swift's flow.collect function only receives first value](https://github.com/Kotlin/kotlinx.coroutines/issues/2306)
`Collector`ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹éš›ã«å‚è€ƒã«è‡´ã—ã¾ã—ãŸã€‚

# å‚™è€ƒ
æœ¬è¨˜äº‹ã¯ä»¥ä¸‹ã®ç’°å¢ƒã§æ¤œè¨¼ã—ã¾ã—ãŸ

```
Fleet: 1.44.151
Android Studio: 2024.1 (AI-241.18034.62.2411.12071903)
Xcode 16.2
```
