---
title: "ã€Flutter, Dartã€‘Signals 6.0 ã®æ–°æ©Ÿèƒ½ã‚’ç´¹ä»‹"
emoji: "ğŸ›œ"
type: "tech"
topics: [flutter, dart, signals, signal, architecture]
publication_name: "zoome"
published: true
---

çŠ¶æ…‹ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®[Signals](https://dartsignals.dev/reference/install/)ãŒ5.5â†’6.0ã§å¤§å¹…ã«æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚ŒãŸã®ã§ã”ç´¹ä»‹ã—ã¾ã™ã€‚

:::message
åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¯[ã“ã¡ã‚‰ã®è¨˜äº‹](934a23c014c52b)ã‚’ã”è¦§ãã ã•ã„ã€‚
:::

# Mixinã§ç‹¬è‡ªã®`Signal`ã‚„`Computed`ãŒä½œã‚Œã‚‹
ã“ã‚Œã¾ã§ã¯
* `Signal`ï¼ˆ`Riverpod`ã®`StateProvider`ã«ç›¸å½“ï¼‰
* `Computed`ï¼ˆ`Riverpod`ã®`Provider`ã«ç›¸å½“ï¼‰

ã‚’ä½¿ã£ã¦çŠ¶æ…‹ç®¡ç†ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã—ãŸã€‚
ãã‚Œã§ã‚‚`AsyncSignal`ã‚„`FutureSignal`ãªã©å¤§æŠµã®æ©Ÿèƒ½ãŒæƒã£ã¦ã„ã‚‹ã®ã§ä¾¿åˆ©ã§ã—ãŸãŒã€6.0ã‹ã‚‰ã¯**Mixin**ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ç‹¬è‡ªã®`Signal`ãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã“ã‚Œã«ã‚ˆã£ã¦`Riverpod`ã®`NotifierProvider`ã‚„`AsyncNotifierProvider`ã®ã‚ˆã†ãªä½¿ã„æ–¹ã‚‚å¯èƒ½ã«ãªã£ãŸã ã‘ã§ã¯ãªãã€**Signalsç‹¬è‡ªã®ç‰¹é•·ã‚’ç”Ÿã‹ã—ãŸçŠ¶æ…‹ç®¡ç†**ãŒè¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## `ChangeStackSignalMixin`
éå»ã®çŠ¶æ…‹ã‚’è¨˜æ†¶ã—ã€`undo`ã¨`redo`ã§è‡ªç”±ã«å¾©å…ƒã—ãŸã‚Šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹`Mixin`ã§ã™ã€‚
ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚„ãƒšã‚¤ãƒ³ãƒˆã‚¢ãƒ—ãƒªã«ã‚ˆãã‚ã‚‹æ©Ÿèƒ½ãŒç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã—ã€APIå‘¨ã‚Šã§ã‚‚ä½¿ã„æ‰€ãŒã‚ã‚Šãã†ã§ã™ã­ã€‚
```dart
class MySignal extends Signal<int> with ChangeStackSignalMixin<int> {
  MySignal(super.internalValue);

  @override
  int get limit => 3; // ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨å±¥æ­´ã«ä¸Šé™ãŒæŒãŸã›ã‚‰ã‚Œã‚‹
}

void main() {
  final signal = MySignal(0);

  signal.value = 1;
  print(signal.canUndo); // true

  signal.undo();
  print(signal.value); // 0
  print(signal.canUndo); // false

  signal.redo();
  print(signal.value); // 1

  signal.value = 2;
  signal.value = 3;
  signal.value = 4;
  signal.undo();
  print(signal.value); // 3

  // historyã§undoã€redosã§redoã™ã‚‹å‰ãƒ»å¾Œã®å€¤ã‚’ä¸€è¦§ã§å–å¾—ã§ãã‚‹
  print(signal.history); // {(previousValue: 1, value: 2), (previousValue: 2, value: 3)}
  print(signal.redos); // {(previousValue: 3, value: 4)}
}
```

`ChangeStackSignal`ã‚‚ã‚ã‚‹ã®ã§ã€ç‹¬è‡ª`Signal`ã‚’ä½œã‚‹ã»ã©ã§ãªã„å ´åˆã¯ä¸€è¡Œã§ä½œã‚Œã¾ã™ã€‚
```dart
final history = changeStack(0);
```

## `TrackedSignalMixin`
`Signal`ã®åˆæœŸå€¤ã¨ä¸€ã¤å‰ã®å€¤ã‚’è¨˜æ†¶ã§ãã¾ã™ã€‚
```dart
class MySignal extends Signal<int> with TrackedSignalMixin<int> {
  MySignal(super.internalValue);
}

void main() {
  final signal = MySignal(0);

  print(signal.initialValue); // 0
  print(signal.previousValue); // null

  signal.value = 1;
  print(signal.previousValue); // 0

  signal.value = 2;
  print(signal.previousValue); // 1
}
```
5.5ã¾ã§ã¯`Signal`è‡ªä½“ã«`previousValue`ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ¼ãŒã‚ã‚Šã¾ã—ãŸãŒã€ãã‚ŒãŒ`Mixin`ã«ç§»è¡Œã—ãŸå½¢ã§ã™ã€‚
ä»Šå›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§ã®ç ´å£Šçš„å¤‰æ›´ç‚¹ã§ã™ãŒã€ã“ã‚Œã¾ã§ã¯`previousValue`ã‚’ä½¿ã‚ãªãã¦ã‚‚ä»¥å‰ã®å€¤ã‚’ä¿æŒã—ç¶šã‘ã¦ã„ãŸã®ã§ã€ãƒ¡ãƒ¢ãƒªãƒ¼åŠ¹ç‡ã¨å‡¦ç†é€Ÿåº¦ãŒå‘ä¸Šã—ãŸã¨ã‚‚è¨€ãˆã¾ã™ã€‚

ã“ã¡ã‚‰ã‚‚ä¸€è¡Œã§æ›¸ãã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚
```dart
final history = trackedSignal(0);
```

## `EventSinkSignalMixin`
`add`ã§å€¤ã‚’ã€`addError`ã§ã‚¨ãƒ©ãƒ¼ã‚’é€šçŸ¥ã™ã‚‹`Mixin`ã§ã™ã€‚
`AsyncState`ã¯`hasValue`ã€`hasError`ã€`isLoading`ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã§ã™ãŒã€ãã“ã‹ã‚‰`loading`ã®ç®¡ç†ã‚’æŠœã„ãŸå½¢ã§ã™ã€‚

```dart
class MySignal extends Signal<AsyncState<int>> with EventSinkSignalMixin<int> {
  MySignal(int value) : super(AsyncState.data(value));
}

void main() {
  final signal = MySignal(0);
  signal.add(1);

  print(signal.value.hasValue); // true
  print(signal.value.value); // 1

  signal.addError('error(example)');
  print(signal.value.hasError); // true
  print(signal.value.error); // error(example)

  signal.close();
  print(signal.disposed); // true
}
```

## `ListSignalMixin`ã€€<br>`MapSignalMixin`ã€€<br>`SetSignalMixin`ã€€<br>`IterableSignalMixin`
Riverpodã§`List`ã‚„`Map`ã‚’çŠ¶æ…‹ç®¡ç†ã™ã‚‹éš›ã€`add`ã‚„`[]`ã§å¤‰æ›´ã™ã‚‹ã¨`ref.watch`ã§ç”»é¢ãŒæ›´æ–°ã•ã‚Œãªã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

`ref.notifyListeners()`ã§æ‰‹å‹•é€šçŸ¥ã™ã‚Œã°è‰¯ã„ã®ã§ã™ãŒæ‰‹é–“ã§ã™ã—ã€ãã‚‚ãã‚‚æ›´æ–°ã•ã‚Œãªã„ç†ç”±ã‚’ç†è§£ã™ã‚‹ã«ã¯**ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒ**â€¦ã¨ã‹**Immutableã˜ã‚ƒãªã„ã‹ã‚‰**â€¦ã¨ã‹é›£ã—ã„ç†å±ˆã‚’å­¦ã¶å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

**`Signals`ã§ã¯ä¸è¦ã§ã™**ã€‚

```dart
// List, Set, Map ã®Mixinã¯IterableSignalMixinã¨ã‚»ãƒƒãƒˆã§Mixinã™ã‚‹
class MyListSignal extends Signal<List<int>>
    with IterableSignalMixin<int, List<int>>, ListSignalMixin<int, List<int>> {
  MyListSignal(super.internalValue);
}

void main() {
  final signal = MyListSignal([0]);

  // å€¤ã®å¤‰æ›´ãŒã‚ã‚‹ã¨printã™ã‚‹ï¼ˆåˆæœŸåŒ–æ™‚ã«ã‚‚ä¸€åº¦å‘¼ã°ã‚Œã‚‹ï¼‰
  signal.subscribe(print); // [0]

  signal.add(1); // [0, 1]
  signal.add(2); // [0, 1, 2]
  signal[0] = 100; // [100, 1, 2]
  signal.removeLast(); // [100, 1]
  signal.clear(); // []

  // valueçµŒç”±ã§æ›´æ–°ã™ã‚‹ã¨é€šçŸ¥ã•ã‚Œãªã„ã®ã§æ³¨æ„
  signal.value.add(3);
}
```

```dart: MapSignalMixinã¯ã‚­ãƒ¼ã¨ãƒãƒªãƒ¥ãƒ¼ã®å‹ã‚’ä½µè¨˜ã™ã‚‹
class MyMapSignal extends Signal<Map<String, int>>
    with MapSignalMixin<String, int, Map<String, int>> {
  MyMapSignal(super.internalValue);
}
```

ã“ã¡ã‚‰ã‚‚ãã‚Œãã‚Œä¸€è¡Œã§æ›¸ãã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚
```dart
final priceListsignal = listSignal([100]);
final itemMapSignal = mapSignal({"ã‚Šã‚“ã”": 100});
final priceSetSignal = setSignal({100});
final priceIterableSignal = iterableSignal([100]);
```

## `QueueSignalMixin`
`dart:collection`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚ã‚‹`Queue`ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
ã„ã‚ã‚†ã‚‹åŒæ–¹å‘ãƒªã‚¹ãƒˆã§ã€å…ˆé ­ã«è¿½åŠ ã™ã‚‹é€Ÿåº¦ãŒ`List`ã‚ˆã‚Šæ—©ã„ä»£ã‚ã‚Šã«ä¸€åº¦è¿½åŠ ã—ãŸå€¤ã®æ›´æ–°ãŒå‡ºæ¥ãªã„ã¨ã„ã†ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚
```dart
class MySignal extends Signal<Queue<int>>
    with QueueSignalMixin<int, Queue<int>> {
  MySignal(super.internalValue);
}

void main() {
  final signal = MySignal(Queue.from([0]));

  // å€¤ã®å¤‰æ›´ãŒã‚ã‚‹ã¨printã™ã‚‹ï¼ˆåˆæœŸåŒ–æ™‚ã«ã‚‚ä¸€åº¦å‘¼ã°ã‚Œã‚‹ï¼‰
  signal.subscribe(print); // {0}

  signal.addFirst(-1); // {-1, 0}
  signal.addLast(1); // {-1, 0, 1}
  signal.removeFirst(); // {0, 1}
}
```

```
final signal = queueSignal(Queue.from([0]));
```

## `StreamSignalMixin`
Dartæ¨™æº–ã®`Stream`ã«å¯¾å¿œã™ã‚‹`Signal`ã§ã™ã€‚
æœ€åˆã‹ã‚‰`broadcast`ã•ã‚Œã¦ã„ã‚‹ã®ã§äºŒã¤ä»¥ä¸ŠåŒæ™‚ã«`listen`ã§ãã¾ã™ã€‚
ã“ã‚Œã‚’ä½¿ã†ã¨`StreamBuilder`ã§ã®ç”»é¢æ›´æ–°ã‚‚å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
```dart
class MySignal extends Signal<int> with StreamSignalMixin<int> {
  MySignal(super.internalValue);
}

void main() {
  final signal = MySignal(1);

  final subscription = signal.distinct().listen(print); // 1

  signal.value = 2; // 2
  signal.value = 3; // 3

  // distinct()ã‚’listenã—ã¦ã„ã‚‹ã®ã§ä»¥å‰ã¨åŒã˜å€¤ã¯é€šçŸ¥ã•ã‚Œãªã„
  signal.value = 3;

  signal.value = 4; // 4

  subscription.cancel();

  // listenã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã„ã‚‹ã®ã§é€šçŸ¥ã•ã‚Œãªã„
  signal.value = 5;
}
```

ã“ã¡ã‚‰ã‚‚`streamSignal`ãŒã‚ã‚Šã¾ã™ãŒä½¿ã„å‹æ‰‹ãŒã‹ãªã‚Šç•°ãªã‚Šã¾ã™ï¼ˆè©³ç´°ã¯`streamSignal`ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ï¼‰

# ç‹¬è‡ªã®`Mixin`ã‚’ä½œã‚‹
`ChangeStackSignalMixin`ã‚„`TrackedSignalMixin`ã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãŸã ãã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã‹ã¨æ€ã„ã¾ã™ãŒã€å…¬å¼ã®`Mixin`ã¯éå¸¸ã«ç°¡æ½”ãªä½œã‚Šã‚’ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã‚‰ã‚’å‚è€ƒã«ã™ã‚Œã°ã€ç”¨é€”ã«åˆã‚ã›ã¦ç‹¬è‡ªã®`Mixin`ã‚’ä½œã‚‹ã“ã¨ã‚‚ç°¡å˜ã«å‡ºæ¥ã¾ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ä¾‹ã¨ã—ã¦`SharedPreferences`ã§å€¤ã®ä¿å­˜ã¨èª­ã¿å‡ºã—ã‚’è¡Œã†`PersistedSignalMixin`ã®ä½œã‚Šæ–¹ã‚’è§£èª¬ã—ã¦ã„ã¾ã™ã€‚

https://dartsignals.dev/guides/persisted-signals/

# `Signal`ã®ä»£ã‚ã‚Šã«`Computed`ã‚’ä½¿ã†
`Mixin`ã¯å…¨ã¦`Computed`ã§ã‚‚ä½¿ç”¨å¯èƒ½ã§ã™ã€‚

```dart
class MyComputed extends Computed<int> with TrackedSignalMixin<int> {
  MyComputed(super.internalValue);
}

void main() {
  final price = signal(0);
  final priceComputed = MyComputed(() => price.value);
  
  effect(() {
    print("${priceComputed.value}, ${priceComputed.previousValue}");
  }); // 0, null
  
  price.value = 1; // 1, 0
}
```

# `SignalsProvider`ã§Widgeté–“å—ã‘æ¸¡ã—
ã“ã‚Œã¾ã§ã¯[DIãƒ‘ãƒƒã‚±ãƒ¼ã‚¸](https://dartsignals.dev/guides/dependency-injection/)ã‚’ä½¿ã†ã‹ã€`InheritedWidget`ã‚„ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ã‚ãªã„ã¨Flutterã®Widgetã«`Signal`ã‚’å—ã‘æ¸¡ã™ã“ã¨ãŒå‡ºæ¥ã¾ã›ã‚“ã§ã—ãŸã€‚
6.0ã‹ã‚‰ã¯[provider](https://pub.dev/packages/provider)ã®Signalç‰ˆã§ã‚ã‚‹`SignalProvider`ãŒè¿½åŠ ã•ã‚ŒãŸã®ã§ã€Signalså˜ä½“ã§çŠ¶æ…‹ç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

```dart
import 'package:flutter/material.dart';
import 'package:signals/signals_flutter.dart';

// `SignalProvider`ã§å—ã‘æ¸¡ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯Signalã§ã¯ãªãFlutterSignalã‚’ç¶™æ‰¿ã™ã‚‹
class MySignal extends FlutterSignal<int> with TrackedSignalMixin<int> {
  MySignal(super.internalValue);

  void increment() => value += 1;
}

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      // MySignalsã‚’æ³¨å…¥
      home: SignalProvider(
        create: () => MySignal(0),
        child: const MyHomePage(),
      ),
    );
  }
}

class MyHomePage extends StatefulWidget {
  const MyHomePage({super.key});

  @override
  State<MyHomePage> createState() => _MyHomePageState();
}

class _MyHomePageState extends State<MyHomePage> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: Theme.of(context).colorScheme.inversePrimary,
      ),
      body: Column(mainAxisAlignment: MainAxisAlignment.center, children: [
        if (SignalProvider.of<MySignal>(context)?.value case int count)
          Center(child: Text("value: $count")),
        if (SignalProvider.of<MySignal>(context)?.previousValue
            case int previousCount)
          Center(child: Text("previousValue: $previousCount")),
      ]),
      floatingActionButton: FloatingActionButton(
        onPressed: () =>
            // ç”»é¢æ›´æ–°ã¨é–¢ä¿‚ãªã„å ´æ‰€ã§ã¯ listen: false ã‚’ä»˜ã‘ã‚‹
            SignalProvider.of<MySignal>(context, listen: false)?.increment(),
        child: Text("+"),
      ),
    );
  }
}
```

ã¨ã¯ã„ãˆèª­ã‚“ã§ã„ãŸã ãã¨åˆ†ã‹ã‚‹é€šã‚Šã€`context.watch`ã‚„`context.read`ãŒã¾ã ç„¡ã„ã®ã§ã¡ã‚‡ã£ã¨é•·ã„ã§ã™ã­ï¼ˆ`SignalMultiProvider`ã‚„`SignalBuilder`ã‚‚æ¬²ã—ã„ï¼‰
ä¸€æ˜”å‰ã®[provider](https://pub.dev/packages/provider)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã„ã†å°è±¡ãªã®ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«ä¹ã†ã”æœŸå¾…ã§ã™ã€‚

## ãŠã‚ã‚Šã«
ã“ã‚Œã¾ã§ã®Signalsã¯ã€å˜ä½“ã§ä½¿ã†ã¨ã„ã†ã‚ˆã‚Šä»–ã®çŠ¶æ…‹ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ã†å°è±¡ã§ã—ãŸãŒã€6.0ã‹ã‚‰ã¯ã“ã‚Œä¸€æœ¬ã§ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç†ãŒå‡ºæ¥ã‚‹ä¸Šã«ã€ä»–ã®çŠ¶æ…‹ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¯ãªã„ç‰¹é•·ã‚‚å¢—ãˆãŸã‹ãªã¨æ€ã„ã¾ã™ã€‚

ç§ã¯ä»Šå¾Œå°è¦æ¨¡ãªã‚¢ãƒ—ãƒªé–‹ç™ºã§ã¯Signalså˜ä½“ã®è¨­è¨ˆã‚‚é¸æŠè‚¢ã«ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ï¼ˆç‰¹ã«é€šä¿¡ãŒã»ã¨ã‚“ã©ä¸è¦ãªã‚¢ãƒ—ãƒªï¼‰

:::message
Signalsã«ã¤ã„ã¦ã®çŸ¥è¦‹ã®å…±æœ‰ãŒã—ã‚„ã™ã„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ãŒç„¡ã‹ã£ãŸã®ã§ä½œã‚Šã¾ã—ãŸã€‚
ãŠæ°—è»½ã«ã”å‚åŠ ãã ã•ã„ğŸ˜Š
https://discord.gg/C4bxjk56UQ
:::

# å‚™è€ƒ
æœ¬è¨˜äº‹ã¯ä»¥ä¸‹ã®ç’°å¢ƒã§æ¤œè¨¼ã—ã¾ã—ãŸ

```
Flutter 3.27.1 â€¢ channel stable â€¢ https://github.com/flutter/flutter.git
Framework â€¢ revision 17025dd882 (3 weeks ago) â€¢ 2024-12-17 03:23:09 +0900
Engine â€¢ revision cb4b5fff73
Tools â€¢ Dart 3.6.0 â€¢ DevTools 2.40.2
```