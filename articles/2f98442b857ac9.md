---
title: "ã€Flutterã€‘RiverpodãŒæ‰±ãˆã‚‹ãƒŸãƒ‹ãƒãƒ ãªBLoCãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ§‹ç¯‰"
emoji: "ğŸ§±"
type: "tech"
topics: [flutter,riverpod,bloc]
publication_name: "zoome"
published: true
---

å¼Šç¤¾ã§ã¯MVP (Minimum Viable Product) ã«ã‚ˆã‚‹Flutterã‚¢ãƒ—ãƒªã®é–‹ç™ºã‚’ã—ã¦ãŠã‚Šã¾ã™ã€‚
MVPã¯æ¥µåŠ›ãƒªãƒªãƒ¼ã‚¹ã¾ã§ã®æœŸé–“ã‚’çŸ­ãã—ã€ãã®å¾Œã‚‚é »ç¹ã«ä»•æ§˜å¤‰æ›´ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã€ä¸€èˆ¬çš„ãªé–‹ç™ºæ‰‹æ³•ã§ã‚ã‚‹Riverpodã§ã®MVVMã ã¨ã€ŒModelã¨Viewã®æ··åœ¨åŒ–ã€ãŒèµ·ã“ã‚ŠãŒã¡ã§ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«è‹¦åŠ´ã™ã‚‹ã“ã¨ãŒè‰¯ãã‚ã‚Šã¾ã—ãŸã€‚

ãã“ã§ã€Viewã®è¤‡é›‘åŒ–ã‚’é˜²ããŸã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹BLoCã‚’ç”¨ã„ã¤ã¤ã€Riverpodã®åˆ©ä¾¿æ€§ã‚’ãªã‚‹ã¹ãæãªã‚ãªã„æ‰‹æ³•ã‚’è€ƒæ¡ˆã—ã€å°‘ã—ãšã¤æ”¹è‰¯ã‚’é‡ã­ã¦ã¾ã„ã‚Šã¾ã—ãŸã€‚

# BLoCãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯
:::message
æ—¢ã«BLoCãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯èª­ã¿é£›ã°ã—ã¦ã„ãŸã ã„ã¦æ§‹ã„ã¾ã›ã‚“
:::
MVCã‚„MVVMãªã©ã®è¨­è¨ˆæ‰‹æ³•ã¯ã€ŒViewã¨Modelã‚’åˆ†é›¢ã™ã‚‹ã€ã“ã¨ã‚’ä¸»ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
![Viewã¨Modelã§è²¬å‹™ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹å›³](/images/bpg8ps64ez.webp)
ã“ã‚Œã¯ã€é€šå¸¸ã§ã‚ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€Flutterã¯ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹ç™ºã®å‡ºæ¥ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Šã€**ViewãŒè¤‡é›‘åŒ–ã—ã‚„ã™ã„**å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚
ãã®ãŸã‚æ®µã€…ã¨Viewå´ã«ã€Œ**UIã«é–¢ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯**ã€ãŒæ··ã˜ã£ã¦ã—ã¾ã„â€¦ã€‚
![Viewã« Business Logic ãŒæ··ã–ã£ã¦ã„ã‚‹å›³](/images/y3sswdunxc.webp)
Viewã¨Modelã®å¢ƒç•ŒãŒæ›–æ˜§ã«ãªã‚Šã€ã€Œ**Viewã®ModelåŒ–**ã€ãŒèµ·ã“ã£ã¦ã—ã¾ã„ã¾ã™ã€‚
![Viewã¨Modelã® Business Logic ã®é•ã„ãŒæ›–æ˜§ã«ãªã£ã¦ã„ã‚‹å›³](/images/xcy3cjjf2t.webp)
ã“ã‚Œã§ã¯Viewã«ã‚‚Modelã«ã‚‚æ›¸ã‘ã‚‹å‡¦ç†ã‚’ã©ã¡ã‚‰å´ã«è¨˜è¿°ã™ã‚‹ã®ã‹ã¯ã€å€‹ã€…äººã®è§£é‡ˆæ¬¡ç¬¬ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã­ã€‚

ãã“ã§ã€**ã‚ã‚‹ç¨‹åº¦è¤‡é›‘åŒ–ã—ãŸWidgetã®é›†ã¾ã‚Š**(UI Component)ã¨å¯¾ã«ãªã‚‹**BLoC(Bussiness Logic Component)ã‚¯ãƒ©ã‚¹**ã‚’ä½œæˆã—ã€ã€ŒUIã«é–¢ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ã‚’æ‹…å½“ã•ã›ã‚‹ã“ã¨ã§Viewã‚’æ¥µåŠ›ç°¡æ½”ã«ã—ã‚ˆã†ã€ã¨ã„ã†è¨­è¨ˆæ‰‹æ³•ãŒBLoCãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚
![Viewã€BLoCã€Modelã®é–¢ä¿‚å›³](/images/sn488bnijj.webp)
ã“ã‚Œã ã‘ã§ã¯BLoCã¨ViewModelã¯å¤§å·®ã‚ã‚Šã¾ã›ã‚“ãŒã€
BLoCãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¯ã€Œ**Viewã¨BLoCé–“ã¯å€¤ã®é€šçŸ¥ã—ã‹è¡Œã£ã¦ã¯ãªã‚‰ãªã„**ã€ã¨ã„ã†å¼·ã„åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚
![Viewã¨BLoCé–“ã®é€šçŸ¥ã‚’è¡¨ã—ãŸå›³](/images/r7tahchpxz.webp)
ã“ã‚Œã«ã‚ˆã‚Šã€Viewå´ãŒè¡Œãˆã‚‹ã“ã¨ã¯
* **ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸç­‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’BLoCã«é€šçŸ¥ã™ã‚‹**
* **BLoCã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸå€¤ã‚’åŸºã«Widgetã‚’æ§‹ç¯‰ã™ã‚‹ã€ã‚ã‚‹ã„ã¯ç”»é¢é·ç§»ãªã©ã®ç‰¹å®šã®å‹•ä½œã‚’è¡Œã†**

ã«é™å®šã•ã‚Œã‚‹ãŸã‚ã€æ¥µåŠ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ’ã—ãŸViewã«ãªã‚Šã€ã€ŒViewã®ModelåŒ–ã€ã‚’é˜²ãã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

ã¾ãŸã€é€ã‚‰ã‚Œã¦ããŸå€¤ã‚’å…¨ã¦å‡¦ç†ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãã®Widgetã«å¿…è¦ãªã„å€¤ã¯å—ã‘å–ã‚‰ãªã‘ã‚Œã°è‰¯ã„ã ã‘ãªã®ã§ã€ä¾‹ãˆã°Flutterã‚¢ãƒ—ãƒªã¨FlutterWebã§åŒã˜BLoCã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¤ã¤ã€Viewå´ã®Dartãƒ•ã‚¡ã‚¤ãƒ«ã¯åˆ¥ã€…ã®ã‚‚ã®ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚
ã“ã‚Œã‚‚Viewå´ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ’é™¤ã™ã‚‹ã“ã¨ã®æ©æµã§ã™ã€‚

# Riverpod State ã‚’éš è”½ã™ã‚‹`BlocState`
[flutter_riverpod](https://pub.dev/packages/flutter_riverpod)ã ã¨Widgetã®`build`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§`ref.watch`ã‚’ç”¨ã„ã‚‹ãŸã‚ã€BLoCãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿç¾ãŒå›°é›£ã§ã™ã€‚
ãªã®ã§ã€[riverpod](https://pub.dev/packages/riverpod)ã‚’ç”¨ã„ã¾ã™ã€‚

`ProviderScope`ã«ã‚ˆã£ã¦éš è”½ã•ã‚Œã¦ã„ã‚‹ã®ã§è¦‹ã‚‹ã“ã¨ã¯å°‘ãªã„ã¨æ€ã„ã¾ã™ãŒã€Riverpodã®DIã‚³ãƒ³ãƒ†ãƒŠã¯`ProviderContainer`ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

[riverpod](https://pub.dev/packages/riverpod)ã«ã¯`ProviderScope`ãŒç„¡ã„ã®ã§ã€ã“ã®`ProviderContainer`ã‚’ç›´æ¥æ‰±ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

[flutter_riverpod](https://pub.dev/packages/flutter_riverpod)ã§ã¯`ref`(`WidgetRef`)ã®`watch`ã‚„`listen`ã§å¤‰æ›´ã‚’å—ã‘å–ã£ãŸã‚Šã€`read(~~~.notifier).state`ã§å€¤ã‚’æ›´æ–°ã—ãŸã‚Šã—ã¾ã™ãŒã€`ProviderContainer`ã«ã‚‚`listen`ã¨`read`ãŒã‚ã‚‹ã®ã§åŒã˜ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚
ï¼ˆ`watch`ã¯ç„¡ã„ã®ã§åˆ¥é€”ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰

ãªã®ã§ã€BLoCã‚¯ãƒ©ã‚¹ã®ä½œæˆæ™‚ã«`ProviderContainer`ã‚’ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã—ã€Riverpodã¸ã®æ“ä½œã¯å…¨ã¦BLoCå´ãŒè¡Œã†ã“ã¨ã§ã€Riverpodã‚’ä½¿ç”¨ã—ã¤ã¤BLoCãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå®Ÿç¾å¯èƒ½ã§ã™ã€‚

BLoCå´ã§ã®Riverpodã®æ“ä½œã‚’æ‹…å½“ã™ã‚‹ã®ãŒ`BlocState`ã§ã€Riverpodã®Providerã¨å¯¾ã«ãªã‚‹ã‚ˆã†ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
ä¾‹ãˆã°ã€å…¥åŠ›ã•ã‚ŒãŸæ–‡ç« ã‚’ä¿æŒã™ã‚‹`inputTextProvider`ã¨ã„ã†`StateProvider`ãŒã‚ã£ãŸå ´åˆã€`inputText`ã¨ã„ã†`BlocState`ã‚’ä½œæˆã—ã€ä¸¡è€…ã‚’ç¹‹ãã¾ã™ã€‚

![Riverpodã‚’BlocStateã«ã‚ˆã£ã¦éš è”½ã—ã¦ã„ã‚‹å›³](/images/ueek4khdm2.webp)

ã“ã“ã§é‡è¦ãªã®ã¯ã€Viewå´ã§ã¯`riverpod.dart`ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãªã„ã“ã¨ã§ã™ã€‚
Viewã¯BLoCã¨ã®ã‚„ã‚Šå–ã‚Šã«é›†ä¸­ã•ã›ã‚‹ã¹ãã§ã‚ã‚Šã€Riverpodã®å­˜åœ¨ã‚’çŸ¥ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ï¼ˆæœ¬è¨˜äº‹ã®å®Ÿè£…ä¾‹ã§ã¯`ProviderContainer`ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€æœ¬æ¥ã¯ã—ãªãã¦ã‚‚è‰¯ã„ã‚ˆã†ã«å®Ÿè£…ã§ãã¾ã™ï¼‰

:::message
ã“ã‚Œä»¥é™ã®è¨˜äº‹ã®å®Ÿè£…ã¯ã€ä»Šå¾Œ[Signals](https://dartsignals.dev)ã‚’åŸºã«å¤§å¹…ã«æ”¹è‰¯ã™ã‚‹äºˆå®šã§ã™ã€‚
ãªã®ã§èª­ã‚€ä¾¡å€¤ãŒè–„ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™â€¦ã€‚ã™ã¿ã¾ã›ã‚“ã€‚
:::

# UIã«é–¢ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’é€šçŸ¥ã™ã‚‹`BlocState`

BLoCãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ã€BLoCãŒã€ŒUIã«é–¢ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ã‚’æ‹…å½“ã—ã¾ã™ã€‚
é€šå¸¸ã¯`StatefulWidget`ã®`State`ã®å¤‰æ•°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ï¼‰ã¨ã—ã¦æŒã£ã¦ãŠãã€`setState`ã§æ›´æ–°ã™ã‚‹ã¨æ€ã„ã¾ã™ãŒã€å…ˆã»ã©ã®Riverpodã®`BlocState`ã¨åŒã˜ã‚ˆã†ã«ã€é€šçŸ¥ã«ã‚ˆã£ã¦Viewã¨BLoCé–“ã§ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ãŒæ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

Riverpodã®Providerã¯åŒã˜å€¤ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆã«ç„¡è¦–ã™ã‚‹ï¼ˆé€šçŸ¥ã—ãªã„ï¼‰ä»•æ§˜ã§æ‰±ã„ã¥ã‚‰ã„ãŸã‚ã€ã“ã“ã¯`Stream`ã¨`Sink`ã§ç°¡å˜ãªé€šçŸ¥ãŒè¡Œãˆã‚‹ã‚¯ãƒ©ã‚¹ã‚’è‡ªä½œã—ã¾ã™ã€‚

![ãƒ­ãƒ¼ã‚«ãƒ«Stateã¨Riverpodã®Stateã‚’BlocStateã«ã‚ˆã£ã¦éš è”½ã—ã¦ã„ã‚‹å›³](/images/xjm73t9sns.webp)

Riverpodã®Stateã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã®Stateã‚‚åŒã˜`BlocState`ã§ã‚ã‚Šã€Viewã‹ã‚‰ã¯é•ã„ãŒåˆ¤ã‚Šã¾ã›ã‚“ã€‚

# `BlocState`ã®å®Ÿè£…

ä»Šå›ã€ä»¥ä¸‹ã®4ã¤ã®ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

* BlocState (abstract class)
* _BlocLocalState (BlocStateã‚’ç¶™æ‰¿)
* _BlocRiverpodState (BlocStateã‚’ç¶™æ‰¿)
* BlocStateManager

å®Ÿè£…è‡ªä½“ã¯Viewã¨BLoCé–“ã®é€šçŸ¥ã®ãŸã‚ã ã‘ã®ã‚‚ã®ãªã®ã§ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¼ãªã©ã®ä»–ã®è¨­è¨ˆæ‰‹æ³•ã¨å…±å­˜ã§ãã¾ã™ã€‚

## BlocState
```dart
import 'package:context_watch/context_watch.dart';
ãƒ»ãƒ»ãƒ»

abstract class BlocState<T> {
  final _controller = StreamController<T>();

  late final Stream<T> _stream = _controller.stream.asBroadcastStream();
  late final Sink<T> _sink = _controller.sink;

  StreamSubscription<T>? _streamSubscription;

  final _listenList = <Future<void> Function(T, bool)>[];
  Future<void> Function(T, bool)? _uniqueListen;

  T get value;

  void _listen(void Function(T value) onData, bool unique, bool distinct, bool immediately);

  void listen(void Function(T value) onData, {bool distinct = true, bool immediately = false}) =>
      _listen(onData, false, distinct, immediately);

  void uniqueListen(void Function(T value) onData, {bool distinct = true, bool immediately = false}) =>
      _listen(onData, true, distinct, immediately);

  void add(T value);

  T watch(BuildContext context) {
    final snapShot = _stream.watch(context);
    return snapShot.hasData ? snapShot.data! : value;
  }

  void _close() {
    _streamSubscription?.cancel();
    _sink.close();
    _controller.close();
  }
}
```

`BlocState`ã¯`_BlocRiverpodState`ã¨`_BlocLocalState`ã®è¦ªã‚¯ãƒ©ã‚¹ã§ã‚ã‚Šã€ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã©ã‚Œã‚‚Riverpodã¨åŒç­‰ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
* `value`
  Riverpodã®`ref.read`ã®ä»£ã‚ã‚Š
  BLoCã‚¯ãƒ©ã‚¹ã§å‘¼ã¶ãŸã‚ã®ã‚‚ã®ãªã®ã§ã€Viewå´ã§ã®ä½¿ç”¨ã¯åŸå‰‡ç¦æ­¢ã§ã™
* `listen`
* `uniqueListen`
  Widgetã®`build`å†…ã§ä½¿ç”¨ã™ã‚‹`listen`
  `listen`ã ã¨å†æç”»ã•ã‚Œã‚‹åº¦ã«`_listenList`ã«è¿½åŠ ã•ã‚Œã¦ã—ã¾ã†ãŸã‚
* `add`
  Riverpodã®`ref.read(~~~.notifier).state`ã‚„`setState`ã®ä»£ã‚ã‚Š
  å€¤ã‚’æ›´æ–°ã—ã€`listen`ã«å¤‰æ›´ã‚’é€šçŸ¥ã—ã¾ã™
* `watch`
  Riverpodã®`ref.watch`ã®ä»£ã‚ã‚Š
  [context_watch](https://pub.dev/packages/context_watch)ã‚’ä½¿ç”¨
  ã‚³ãƒ¼ãƒ‰ã‚’çŸ­ãã™ã‚‹ãŸã‚ã®ã‚‚ã®ãªã®ã§ã€`StreamBuilder`ã‚’ä½¿ã†ã®ã§ã‚ã‚Œã°ä¸è¦ã§ã™

## _BlocLocalState
```dart
class _BlocLocalState<T> extends BlocState<T> {
  T _value;

  @override
  T get value => _value;

  _BlocLocalState(this._value) : super() {
    _streamSubscription = _stream.listen((value) {
      final isChange = _value != value;
      _value = value;
      if (_uniqueListen != null) _uniqueListen!(value, isChange);
      for (final listen in _listenList) listen(value, isChange);
    });
  }

  @override
  void _listen(void Function(T value) onData, bool unique, bool distinct, bool immediately) {
    final listen = distinct
        ? (T value, bool isChange) async {
            if (isChange) onData(value);
          }
        : (T value, bool isChange) async => onData(value);

    if (unique) {
      _uniqueListen = listen;
    } else {
      _listenList.add(listen);
    }

    if (immediately) listen(value, true);
  }

  @override
  void add(T value) {
    if (!_controller.isClosed) _sink.add(value);
  }
}
```

`BlocLocalState`ã¯UIã«é–¢ã™ã‚‹å€¤ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šçŸ¥ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
å‡ºæ¥ã‚‹ã“ã¨ã¯Riverpodã®`StateProvider`ã¨ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚
`listen`ã®`distinct`ãŒ`false`ã®å ´åˆã€`add`ã«ä»¥å‰ã¨åŒã˜å€¤ãŒå…¥åŠ›ã•ã‚Œã¦ã‚‚`listen`ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

## _BlocRiverpodState
```dart
import 'package:riverpod/riverpod.dart';
ãƒ»ãƒ»ãƒ»

class _BlocRiverpodState<T> extends BlocState<T> {
  late final ProviderSubscription _providerSubscription;
  final ProviderContainer _container;
  final ProviderListenable<T> _provider;

  @override
  T get value => _provider.read(_container);

  _BlocRiverpodState(this._container, this._provider) : super() {
    _providerSubscription = _container.listen<T>(_provider as dynamic, (_, next) async {
      if (!_controller.isClosed) _sink.add(next);
      for (final listen in _listenList) listen(next, true);
      if (_uniqueListen != null) _uniqueListen!(next, true);
    });
  }

  @override
  void _listen(void Function(T value) onData, bool unique, bool distinct, bool immediately) {
    final listen = distinct
        ? (T value, bool isChange) async {
            if (isChange) onData(value);
          }
        : (T value, bool isChange) async => onData(value);

    if (unique) {
      _uniqueListen = listen;
    } else {
      _listenList.add(listen);
    }

    if (immediately) listen(_container.read(_provider as dynamic), true);
  }

  @override
  void add(T value) {
    if (!_controller.isClosed) _sink.add(value);
    if (_provider is StateNotifierProvider || _provider is AutoDisposeStateNotifierProvider) {
      _container.read((_provider as dynamic).notifier).setState(value);
    } else if (_provider is StateProvider || _provider is AutoDisposeStateProvider) {
      _container.read((_provider as dynamic).notifier).state = value;
    }
  }

  @override
  void _close() {
    _providerSubscription.close();
    super._close();
  }
}
```

`BlocRiverpodState`ã¯Riverpodã®Providerã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
Riverpodã®ä»•æ§˜ä¸Š`distinct`ã‚’`false`ã«è¨­å®šã—ã¦ã‚‚å€¤ã®é‡è¤‡ã‚’è¨±å®¹ã§ãã¾ã›ã‚“ã€‚

## BlocStateManager
```dart
class BlocStateManager {
  final _list = <BlocState>{};

  BlocStateManager();

  BlocState<T> local<T>(T value) {
    final state = _BlocLocalState<T>(value);
    _list.add(state);

    return state;
  }

  BlocState <T> riverpod<T>(r.ProviderContainer container, r.ProviderListenable<T> provider) {
    final state = _BlocRiverpodState<T>(container, provider);
    _list.add(state);

    return state;
  }

  void dispose() {
    for (final state in _list) state._close();
  }
}
```

`BlocStateManager`ã¯ã€ä¸€ã¤ã®BLoCã‚¯ãƒ©ã‚¹å†…ã§ä½¿ç”¨ã™ã‚‹`BlocState`ã®ä½œæˆã¨ç ´æ£„ã‚’åŠ¹ç‡ã‚ˆãè¡Œã†ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
å®Ÿè£…ã¯å˜ç´”ã§ã€`BlocState`ãŒä½œæˆã•ã‚Œã‚‹åº¦ã«é…åˆ—ã«è¿½åŠ ã—ã¦ã„ãã€`dispose`ãŒå‘¼ã°ã‚Œã‚‹ã¨ã¾ã¨ã‚ã¦ç ´æ£„ã™ã‚‹å‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

# å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹
ä»Šå›ä½œæˆã—ãŸ4ã¤ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦å®Ÿéš›ã«å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

ã¾ãšã€Riverpodã®`StateProvider`ã¨ã—ã¦`inputTextProvider`ã‚’å®šç¾©ã—ã¾ã™ã€‚

```dart
final inputTextProvider = StateProvider((_) => "");
```

æ¬¡ã«ã€BLoCã‚¯ãƒ©ã‚¹ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚
```dart
class ExampleBloc {
  final ProviderContainer _container;
  final _state = BlocStateManager();

  late final inputText = _state.riverpod(_container, inputTextProvider);

  late final buttonTapped = _state.local(false);
  late final gotoNextPage = _state.local(false);

  ExampleBloc(this._container) {
    buttonTapped.listen((_) => gotoNextPage.add(true), distinct: false);
  }

  void dispose() => _state.dispose();
}
```

`late final`ã§å®£è¨€ã—ã¦ã„ã‚‹å¤‰æ•°ãŒ`BlocState`ã§ã™ã€‚

`inputTextProvider`ã‚’`inputText`ã¨ç¹‹ãã€ãƒ­ãƒ¼ã‚«ãƒ«ã®Stateã¨ã—ã¦`buttonTapped`ã¨`gotoNextPage`ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
`bool`å‹ã«ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã¯ä½¿ã†ã“ã¨ãŒç„¡ã„ã®ã§å‹ã¯ä½•ã§ã‚‚è‰¯ã„ã§ã™ï¼ˆ`void`å‹ã«ã—ãŸã‹ã£ãŸã®ã§ã™ãŒLinterã«æ€’ã‚‰ã‚Œã¾ã—ãŸï¼‰
ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å†…ã§`listen`ã—ã¦ã€`buttonTapped`ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨`gotoNextPage`ã‚‚æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

æœ€å¾Œã«Viewå´ã®å®Ÿè£…ã§ã™ãŒã€`ProviderContainer`ã‚’BLoCã«æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
è‰²ã€…ãªæ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯[provider](https://pub.dev/packages/provider)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```dart
void main() {
  runApp(ContextWatch.root(child: const MyApp()));
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) => Provider(
        create: (_) => ProviderContainer(),
        child: const MaterialApp(home: ExamplePage()),
      );
}

class ExamplePage extends StatelessWidget {
  const ExamplePage({super.key});

  @override
  Widget build(BuildContext context) => Provider(
        create: (_) => ExampleBloc(context.read<ProviderContainer>()),
        child: Scaffold(
          appBar: AppBar(),
          body: Container(
            alignment: Alignment.center,
            margin: const EdgeInsets.all(20),
            child: const _ExampleBodyPage(),
          ),
        ),
      );
}

class _ExampleBodyPage extends StatefulWidget {
  const _ExampleBodyPage();

  @override
  State<_ExampleBodyPage> createState() => _ExampleBodyPageState();
}

class _ExampleBodyPageState extends State<_ExampleBodyPage> {
  final textEditingController = TextEditingController();

  @override
  Widget build(BuildContext context) {
    final bloc = context.read<ExampleBloc>();

    bloc.gotoNextPage.uniqueListen((_) {
      Navigator.of(context).push(MaterialPageRoute(builder: (context) => const ExamplePage()));
    }, distinct: false);

    bloc.inputText.uniqueListen((value) {
      if (textEditingController.text != value) textEditingController.text = value;
    }, immediately: true);

    return Column(mainAxisAlignment: MainAxisAlignment.center, children: [
      Text("inputText is \"${bloc.inputText.watch(context)}\"", style: Theme.of(context).textTheme.headlineMedium),
      TextField(controller: textEditingController, onChanged: bloc.inputText.add),
      Container(
        margin: const EdgeInsets.only(top: 20),
        child: ElevatedButton(
          onPressed: () => bloc.buttonTapped.add(true),
          child: const Text("Go to next page"),
        ),
      ),
    ]);
  }
}
```

`ContextWatch.root`ã¯[context_watch](https://pub.dev/packages/context_watch)ã‚’ç”¨ã„ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
ï¼ˆ`watch`ã‚’å®Ÿè£…ã—ãªã„ã®ã§ã‚ã‚Œã°ä¸è¦ï¼‰

ã“ã‚Œã§`TextField`ã«å…¥åŠ›ã—ãŸæ–‡ç« ãŒ`inputTextProvider`ã«åæ˜ ã•ã‚Œã€æ¬¡ã®ç”»é¢ã«é·ç§»ã—ã¦ã‚‚ä¿æŒã•ã‚Œã‚‹BLoCãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå‡ºæ¥ã¾ã—ãŸã€‚

# æ–°ã—ã„Stateã‚’ä½œã‚‹
ã“ã®æ‰‹æ³•ã¯å˜ç´”ãªæ§‹é€ ãªã®ã§ã€Riverpodä»¥å¤–ã®Stateã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚

ä¾‹ãˆã°ã€å°†æ¥çš„ã«ã¯Swiftã‚„Kotlinã«ã‚ã‚‹å€¤ã®å¤‰åŒ–ã‚’é€šçŸ¥ã™ã‚‹`NativeState`ã‚‚æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚
`add`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨ã„ã‚‹ã¨[`MethodChannel`](https://api.flutter.dev/flutter/services/MethodChannel-class.html)çµŒç”±ã§å€¤ã®æ›´æ–°ãŒè¡Œãˆã€`listen`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨ã„ã‚‹ã¨[`EventChannel`](https://api.flutter.dev/flutter/services/EventChannel-class.html)çµŒç”±ã§å€¤ã®å¤‰åŒ–ãŒé€šçŸ¥ã•ã‚Œã¾ã™ã€‚

Riverpodä»¥å¤–ã®çŠ¶æ…‹ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨ã„ãŸã„æ™‚ã‚‚ã€æ–°ã—ã„Stateã‚’ä½œã‚Œã°è‰¯ã„ã ã‘ã§ã™ã€‚Viewå´ã‹ã‚‰è¦‹ã‚‹ã¨ã©ã‚Œã‚‚åŒã˜`BlocState`ã§ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

# ãŠã‚ã‚Šã«
ã“ã®è¨­è¨ˆæ‰‹æ³•ã¯å¿…è¦ã«é§†ã‚‰ã‚Œã¦å°‘ã—ãšã¤æ”¹è‰¯ã‚’é‡ã­ã¦ã„ã£ãŸã‚‚ã®ãªã®ã§ã€ã¾ã è¶³ã‚Šãªã„ã‚‚ã®ã‚„æ”¹å–„ç‚¹ãŒå¤šã€…ã‚ã‚Šã¾ã™ã€‚

ã¨ã¯ã„ãˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’ã™ã‚‹æ™‚ã‚‚ã€Viewå´ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ’é™¤ã—ã€BLoCå†…ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’Modelã«ç§»ã—ã¦ã„ãã ã‘ã§ç¶ºéº—ãªã‚³ãƒ¼ãƒ‰ã«å‡ºæ¥ã‚‹ã¨ã„ã†ç‚¹ã§ã€åˆ¤ã‚Šã‚„ã™ãä¾¿åˆ©ã§ã™ã€‚

# å‚è€ƒæ–‡çŒ®
* [Flutter / AngularDart â€“ Code sharing, better together (DartConf 2018)](https://www.youtube.com/watch?v=PLHln7wHgPE)

# å‚™è€ƒ
æœ¬è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã¯å•†ç”¨ãƒ»éå•†ç”¨é–¢ä¿‚ãªãè‡ªç”±ã«æ”¹å¤‰ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ãŒã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã¨ã—ã¦å…¬é–‹ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚
ï¼ˆå°†æ¥çš„ã«ç§ãŒpub.devã«å…¬é–‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã§ã™ï¼‰

æœ¬è¨˜äº‹ã¯ä»¥ä¸‹ã®ç’°å¢ƒã§æ¤œè¨¼ã—ã¾ã—ãŸ
```
Flutter 3.22.2 â€¢ channel stable â€¢ https://github.com/flutter/flutter.git
Framework â€¢ revision 761747bfc5 (5 weeks ago) â€¢ 2024-06-05 22:15:13 +0200
Engine â€¢ revision edd8546116
Tools â€¢ Dart 3.4.3 â€¢ DevTools 2.34.3
```